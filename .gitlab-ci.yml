stages:
    - Build docker image
    - Test docker image
    - Push container to DTR
    - validate    # - validate the project is correct and all necessary information is available
    - build       # - compile the source code of the project
    - test        # - test the compiled source code using a suitable unit testing framework. These tests should not require the code be packaged or deployed
    - package     # - take the compiled code and package it in its distributable format, such as a JAR.
    - verify      # - run any checks on results of integration tests to ensure quality criteria are met
    - install     # - install the package into the local repository, for use as a dependency in other projects locally
    - deploy      # - done in the build environment, copies the final package to the remote repository for sharing with other developers and 

# When using dind, it's wise to use the overlayfs driver for
# improved performance.
variables:
    DOCKER_DRIVER: "overlay2"
    # fill those if you have a proxy in your environment
    http_proxy: 
    https_proxy: 
    no_proxy:
    STAGING_REGISTRY: "registry.gitlab.com"
    CONTAINER_DEV_IMAGE: ${STAGING_REGISTRY}/${CI_PROJECT_NAME}:${CI_BUILD_REF_NAME}_${CI_BUILD_REF}_test
    CONTAINER_RELEASE_IMAGE: ${STAGING_REGISTRY}/${CI_PROJECT_NAME}:${CI_BUILD_REF_NAME}_${CI_BUILD_REF}

before_script:
    - docker info
#     - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $STAGING_REGISTRY
#     - echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USER" --password-stdin

after_script:
    - docker info
#    - docker logout ${CI_REGISTRY}

.agent-who: &agent-who
    retry: 1
    tags:
        - agent-smith

.unit-test: &unit-test
    stage: test
    variables: &unit-test-variable
        DDS_TYPE: OPENDDS

    before_script:
        - echo ${DDS_TYPE} $BUILD_OPTIONS

    script:
        - echo ${DDS_TYPE} $BUILD_OPTIONS

    after_script:
        - echo ${DDS_TYPE} $BUILD_OPTIONS

    dependencies: []
    only:
        - master
        - tags

.build_template: &build_definition
    stage: build
    script:
        - cmake -E make_directory build
        - cmake -E chdir build cmake .. -G "${BUILD_GENERATOR}" 
                -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} 
                -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_INSTALL_PREFIX=$CI_PROJECT_NAMESPACE/dds
        - cmake --build build --target all --clean-first
        - cmake --build build --target install
    artifacts:
        name: "slg-${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
        when: always
        paths:
        - "build/*"

.docker-prerequisities: &docker-prerequisities
    image: docker:stable
    services:
        - docker:dind

docker build:
    <<: *docker-prerequisities
    stage: Build docker image
    script:
        - docker info
#        - time docker build -t registry.gitlab.com/doevelopper/cfs-com:0.0.1 -f src/main/resources/docker/amd64/foss.Dockerfile .

docker test:
    <<: *docker-prerequisities
    stage: Test docker image
    script:
        - docker info
#        - time docker build -t registry.gitlab.com/doevelopper/cfs-com:0.0.1 -f src/main/resources/docker/amd64/foss.Dockerfile .

docker push:
    <<: *docker-prerequisities
    stage: Push container to DTR
    only:
        - master
    script:
        - docker info
#        - time docker tag registry.gitlab.com/doevelopper/cfs-com:0.0.1 doevelopper/foss-dds-dev:0.0.1
#        - docker push ""

unit-test:adlinktech:
    image: registry.gitlab.com/doevelopper/cfs-com/vortex:latest
    <<: *unit-test
    variables:
        <<: *unit-test-variable
        DDS_TYPE: vortex-opensplice

unit-test:objectcomputing:
    image: registry.gitlab.com/doevelopper/cfs-com/opendds:latest
    <<: *unit-test
    variables:
        <<: *unit-test-variable
        DDS_TYPE: opendds

unit-test:eProsima:
    image: registry.gitlab.com/doevelopper/cfs-com/eprosima:latest
    <<: *unit-test
    variables:
        <<: *unit-test-variable
        DDS_TYPE: fast-RTPS

unit-test:real-time-innovation:
    image: registry.gitlab.com/doevelopper/cfs-com/connext:latest
    <<: *unit-test
    variables:
        <<: *unit-test-variable
        DDS_TYPE: ConnextDDS



